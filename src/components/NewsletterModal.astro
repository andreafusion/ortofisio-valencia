---
import { site } from '../data/site';
---

{site.newsletter.enabled && (
<div
  class="modal-overlay"
  id="newsletter-overlay"
  role="dialog"
  aria-modal="true"
  aria-labelledby="modal-title"
  hidden
>
  <div class="modal">
    <button
      class="modal__close"
      id="modal-close"
      aria-label="Cerrar ventana"
      type="button"
    >
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
        <line x1="1" y1="1" x2="15" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        <line x1="15" y1="1" x2="1" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
      </svg>
    </button>

    <h2 id="modal-title" class="modal__title">{site.newsletter.title}</h2>
    <p class="modal__subtitle">{site.newsletter.subtitle}</p>
    <p class="modal__desc">{site.newsletter.description}</p>

    <form id="newsletter-form" novalidate>
      <div class="modal__field">
        <label for="newsletter-email" class="sr-only">{site.newsletter.placeholder}</label>
        <input
          type="email"
          id="newsletter-email"
          name="email"
          placeholder={site.newsletter.placeholder}
          required
          autocomplete="email"
        />
      </div>
      <button type="submit" class="btn btn--primary">Suscribirme</button>
      <p class="modal__legal">{site.newsletter.legal}</p>
    </form>

    <p class="modal__success" id="modal-success" hidden>
      {site.newsletter.successMsg}
    </p>
  </div>
</div>
)}

<script>
  window.addEventListener('load', () => {
    const overlay   = document.getElementById('newsletter-overlay')  as HTMLElement | null;
    const closeBtn  = document.getElementById('modal-close')          as HTMLButtonElement | null;
    const form      = document.getElementById('newsletter-form')      as HTMLFormElement | null;
    const successMsg= document.getElementById('modal-success')        as HTMLElement | null;

    if (!overlay) return;

    function openModal()  { overlay!.hidden = false; closeBtn?.focus(); }
    function closeModal() {
      overlay!.hidden = true;
      try {
        localStorage.setItem('newsletter-dismissed', String(Date.now() + 24 * 60 * 60 * 1000));
      } catch (_e) {}
    }

    let shouldShow = true;
    try {
      const stored = localStorage.getItem('newsletter-dismissed');
      if (stored && Date.now() < Number(stored)) shouldShow = false;
    } catch (_e) {}

    if (shouldShow) setTimeout(openModal, 10_000);

    closeBtn?.addEventListener('click', (e) => { e.stopPropagation(); closeModal(); });
    overlay.addEventListener('click',   (e) => { if (e.target === overlay) closeModal(); });
    document.addEventListener('keydown',(e) => { if (e.key === 'Escape' && !overlay.hidden) closeModal(); });

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const input     = form.querySelector('#newsletter-email') as HTMLInputElement;
      const email     = input?.value?.trim();
      const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      if (!email) return;

      submitBtn.disabled    = true;
      submitBtn.textContent = 'Enviando...';

      try {
        const res  = await fetch('/api/newsletter', {
          method:  'POST',
          headers: { 'Content-Type': 'application/json' },
          body:    JSON.stringify({ email }),
        });
        const data = await res.json();

        if (res.ok && data.ok) {
          if (form)       form.hidden       = true;
          if (successMsg) successMsg.hidden = false;
          setTimeout(closeModal, 2500);
        } else {
          submitBtn.disabled    = false;
          submitBtn.textContent = 'Suscribirme';
          alert(data.error ?? 'Algo salió mal. Inténtalo de nuevo.');
        }
      } catch (_e) {
        submitBtn.disabled    = false;
        submitBtn.textContent = 'Suscribirme';
        alert('Error de conexión. Inténtalo de nuevo.');
      }
    });
  });
</script>